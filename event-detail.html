<!DOCTYPE html>
<html class="has-sidemenu" lang="ko-KR" dir="ltr">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="민족통일청년회 영동군 지부 - 행사 상세">

    <title>행사 상세 | 민족통일청년회 영동군</title>

    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicons/favicon-16x16.png">
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicons/favicon.ico">
    <link rel="manifest" href="assets/img/favicons/manifest.json">
    <meta name="msapplication-TileImage" content="assets/img/favicons/mstile-150x150.png">
    <meta name="theme-color" content="#ffffff">

    <link href="vendors/loaders.css/loaders.min.css" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=PT+Mono%7cPT+Serif:400,400i%7cLato:100,300,400,700,800,900" rel="stylesheet">
    <link href="assets/css/theme.css" rel="stylesheet" />
    <link href="assets/css/user.css" rel="stylesheet" />
  </head>

  <body class="overflow-hidden-x">

    <nav class="fancynavbar fancynavbar-expand-lg">
      <div class="fancynavbar-togglerbar"><a class="fancynavbar-brand" href="index.html"><img class="fancynavbar-brand-img" src="assets/img/logo-sparrow-invert.svg" alt="" width="30" height="30" /></a>
        <div class="fancynavbar-toggler">
          <svg class="fancynavbar-toggler-icon" viewBox="0 0 70 70" xmlns="http://www.w3.org/2000/svg">
            <path id="path-top" d="M20,25c0,0,22,0,30,0c16,0,18.89,40.71-.15,21.75C38.7,35.65,19.9,16.8,19.9,16.8"></path>
            <path id="path-middle" d="M20,32h30"></path>
            <path id="path-bottom" d="M19.9,46.98c0,0,18.8-18.85,29.95-29.95C68.89-1.92,66,38.78,50,38.78c-8,0-30,0-30,0"></path>
          </svg>
        </div>
        <div class="fancynavbar-addon fancynavbar-addon-height"><a class="fancynavbar-addon-item" href="#!"><span class="fab fa-twitter"></span></a><a class="fancynavbar-addon-item" href="#!"><span class="fab fa-facebook"></span></a>
        </div>
      </div>
      <div class="fancynavbar-collapse">
        <ul class="fancynavbar-nav">
          <li class="fancynav-item"><a class="fancynav-link" href="index.html"><span class="fancynav-link-content">홈</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="about.html"><span class="fancynav-link-content">협의회 소개</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="services.html"><span class="fancynav-link-content">사업 안내</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="members.html"><span class="fancynav-link-content">회원소개</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="news.html"><span class="fancynav-link-content">활동 소식</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link active" href="events.html"><span class="fancynav-link-content">행사 안내</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="contact.html"><span class="fancynav-link-content">연락처</span></a></li>
        </ul>
      </div>
    </nav>

    <main class="main min-vh-100" id="top">

      <div class="preloader" id="preloader">
        <div class="loader">
          <div class="line-scale-pulse-out-rapid">
            <div> </div>
            <div></div>
            <div></div>
            <div></div>
            <div> </div>
          </div>
        </div>
      </div>

      <section class="py-7 py-md-9">
        <div class="container">

          <!-- 로딩 -->
          <div id="eventLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">로딩중...</span>
            </div>
          </div>

          <!-- 행사 정보 -->
          <div id="eventDetail" style="display:none;">
            <div class="row mb-5">
              <div class="col-12">
                <a href="events.html" class="btn btn-outline-secondary btn-sm mb-4">
                  <span class="fas fa-arrow-left me-2"></span>목록으로
                </a>

                <div class="d-flex align-items-start">
                  <div class="bg-primary text-white rounded text-center me-3 flex-shrink-0" style="width: 50px; padding: 8px;">
                    <div class="fw-bold lh-1" style="font-size: 1.3rem;" id="eventDay"></div>
                    <div style="font-size: 0.65rem;" id="eventMonth"></div>
                  </div>
                  <div class="flex-grow-1">
                    <h1 class="mb-1" style="font-size: 1.1rem;" id="eventTitle"></h1>
                    <p class="text-body-secondary mb-1" style="font-size: 0.8rem;" id="eventDayOfWeek"></p>
                    <p class="text-body-secondary mb-0" style="font-size: 0.8rem;" id="eventLocation"></p>
                  </div>
                </div>

                <!-- 대표 이미지 -->
                <div id="eventMainImage" class="mt-4" style="display:none;">
                  <img id="mainImage" src="" alt="" class="img-fluid rounded" style="max-height: 400px; object-fit: cover; width: 100%;">
                </div>

                <!-- 내용 -->
                <div class="mt-4" id="eventContent"></div>
              </div>
            </div>

            <hr class="my-5">

            <!-- 행사 사진 섹션 -->
            <div class="row">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h3 class="mb-0" style="font-size: 1rem;">
                    <span class="fas fa-images me-2 text-primary"></span>행사 사진
                  </h3>
                  <button class="btn btn-primary btn-sm" style="font-size: 0.75rem;" data-bs-toggle="modal" data-bs-target="#uploadPhotoModal">
                    <span class="fas fa-plus me-1"></span>사진 올리기
                  </button>
                </div>

                <!-- 사진 로딩 -->
                <div id="photosLoading" class="text-center py-4">
                  <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">로딩중...</span>
                  </div>
                </div>

                <!-- 사진 갤러리 -->
                <div class="row g-3" id="eventPhotos">
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

    </main>

    <!-- 사진 업로드 모달 -->
    <div class="modal fade" id="uploadPhotoModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">행사 사진 올리기</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="uploadPhotoForm">
              <div class="mb-3">
                <label for="photoFile" class="form-label fw-bold">사진 <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="photoFile" accept="image/*" required>
                <small class="text-body-secondary">JPG, PNG, GIF 형식 (최대 5MB)</small>
              </div>
              <div class="mb-3">
                <label for="photoCaption" class="form-label fw-bold">설명</label>
                <input type="text" class="form-control" id="photoCaption" placeholder="사진 설명 (선택)">
              </div>
              <div id="photoPreview" class="mb-3" style="display:none;">
                <img id="photoPreviewImg" src="" alt="미리보기" class="img-thumbnail w-100">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-primary" onclick="uploadEventPhoto()">
              <span class="fas fa-upload me-2"></span>업로드
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer bg-black text-body-secondary py-4 font-secondary text-center overflow-hidden">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-4 order-lg-2 position-relative"><a class="indicator indicator-up" href="#top"><span class="indicator-arrow indicator-arrow-one"></span><span class="indicator-arrow indicator-arrow-two"></span></a></div>
          <div class="col-lg-4 text-lg-start mt-4 mt-lg-0">
            <p class="fs-10 ls fw-bold mb-0">Copyright &copy; 2025 민족통일청년회 영동군</p>
            <p class="fs-10 mb-0 mt-2"><a href="http://www.mintong.or.kr/mt/main" target="_blank" class="text-body-secondary">민족통일협의회</a></p>
          </div>
          <div class="col-lg-4 text-lg-end order-lg-2 mt-2 mt-lg-0">
            <p class="fs-10 mb-0">충청북도 영동군 | 문의: conexus25@conexus.co.kr</p>
          </div>
        </div>
      </div>
    </footer>

    <script src="vendors/popper/popper.min.js"></script>
    <script src="vendors/bootstrap/bootstrap.min.js"></script>
    <script src="vendors/anchorjs/anchor.min.js"></script>
    <script src="vendors/is/is.min.js"></script>
    <script src="vendors/bigpicture/BigPicture.js"></script>
    <script src="vendors/fontawesome/all.min.js"></script>
    <script src="vendors/lodash/lodash.min.js"></script>
    <script src="vendors/imagesloaded/imagesloaded.pkgd.js"></script>
    <script src="vendors/gsap/gsap.js"></script>
    <script src="vendors/gsap/customEase.js"></script>
    <script src="vendors/gsap/drawSVGPlugin.js"></script>
    <script src="assets/js/theme.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js"></script>

    <script>
      let currentEventId = null;

      // 행사 상세 로드
      async function loadEventDetail() {
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');

        if (!eventId) {
          alert('행사를 찾을 수 없습니다.');
          window.location.href = 'events.html';
          return;
        }

        currentEventId = eventId;

        try {
          const { data: event, error } = await supabase
            .from('news')
            .select('*')
            .eq('id', eventId)
            .single();

          if (error) throw error;

          displayEventDetail(event);
          loadEventPhotos(eventId);
        } catch (error) {
          console.error('행사 로드 오류:', error);
          document.getElementById('eventLoading').innerHTML = `
            <div class="text-center py-5 text-danger">
              <p><span class="fas fa-exclamation-triangle me-2"></span>행사를 불러오는데 실패했습니다.</p>
              <a href="events.html" class="btn btn-outline-primary mt-3">목록으로 돌아가기</a>
            </div>
          `;
        }
      }

      // 행사 정보 표시
      function displayEventDetail(event) {
        const loadingEl = document.getElementById('eventLoading');
        const detailEl = document.getElementById('eventDetail');

        if (loadingEl) loadingEl.style.display = 'none';
        if (detailEl) detailEl.style.display = 'block';

        const eventDate = event.event_date ? new Date(event.event_date) : new Date(event.created_at);
        const month = eventDate.getMonth() + 1;
        const day = eventDate.getDate();
        const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'][eventDate.getDay()];
        const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];

        document.getElementById('eventDay').textContent = day;
        document.getElementById('eventMonth').textContent = monthNames[month - 1];
        document.getElementById('eventTitle').textContent = event.title;
        document.getElementById('eventDayOfWeek').textContent = `${eventDate.getFullYear()}년 ${month}월 ${day}일 ${dayOfWeek}요일`;

        if (event.location) {
          document.getElementById('eventLocation').innerHTML = `<span class="fas fa-map-marker-alt me-2"></span>${escapeHtml(event.location)}`;
        }

        if (event.image_url) {
          document.getElementById('mainImage').src = event.image_url;
          document.getElementById('eventMainImage').style.display = 'block';
        }

        if (event.content) {
          document.getElementById('eventContent').innerHTML = `<p class="text-body-secondary">${escapeHtml(event.content).replace(/\n/g, '<br>')}</p>`;
        }

        // 페이지 타이틀 업데이트
        document.title = `${event.title} | 민족통일청년회 영동군`;
      }

      // 행사 사진 로드
      async function loadEventPhotos(eventId) {
        const loadingEl = document.getElementById('photosLoading');
        const photosContainer = document.getElementById('eventPhotos');

        try {
          const { data: photos, error } = await supabase
            .from('event_photos')
            .select('*')
            .eq('event_id', eventId)
            .order('created_at', { ascending: false });

          if (error) throw error;

          if (loadingEl) loadingEl.style.display = 'none';

          if (!photos || photos.length === 0) {
            photosContainer.innerHTML = `
              <div class="col-12 text-center py-4 text-body-secondary">
                <p><span class="fas fa-camera me-2"></span>등록된 사진이 없습니다.</p>
                <p class="fs-9">위의 "사진 올리기" 버튼을 눌러 행사 사진을 추가하세요.</p>
              </div>
            `;
            return;
          }

          photosContainer.innerHTML = '';

          photos.forEach((photo, index) => {
            const photoHTML = `
              <div class="col-6 col-md-4 col-lg-3">
                <a href="#!" data-bp="${photo.image_url}" data-caption="${escapeHtml(photo.caption || '')}">
                  <img class="rounded w-100" style="height: 200px; object-fit: cover; cursor: pointer;"
                       src="${photo.image_url}" alt="${escapeHtml(photo.caption || '행사 사진')}">
                </a>
                ${photo.caption ? `<p class="text-body-secondary fs-9 mt-1 mb-0">${escapeHtml(photo.caption)}</p>` : ''}
              </div>
            `;
            photosContainer.insertAdjacentHTML('beforeend', photoHTML);
          });

          // BigPicture 초기화
          document.querySelectorAll('[data-bp]').forEach(el => {
            el.addEventListener('click', function(e) {
              e.preventDefault();
              BigPicture({
                el: this
              });
            });
          });

        } catch (error) {
          console.error('사진 로드 오류:', error);
          if (loadingEl) loadingEl.style.display = 'none';
          photosContainer.innerHTML = `
            <div class="col-12 text-center py-4 text-body-secondary">
              <p>사진을 불러오는데 실패했습니다.</p>
            </div>
          `;
        }
      }

      // 사진 업로드
      async function uploadEventPhoto() {
        const fileInput = document.getElementById('photoFile');
        const caption = document.getElementById('photoCaption').value;

        if (!fileInput.files[0]) {
          alert('사진을 선택해주세요.');
          return;
        }

        const file = fileInput.files[0];
        if (file.size > 5 * 1024 * 1024) {
          alert('이미지 크기는 5MB 이하여야 합니다.');
          return;
        }

        try {
          // 파일 업로드
          const fileExt = file.name.split('.').pop();
          const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
          const filePath = `event_photos/${currentEventId}/${fileName}`;

          const { error: uploadError } = await supabase.storage
            .from('events')
            .upload(filePath, file);

          if (uploadError) throw uploadError;

          // URL 가져오기
          const { data: urlData } = supabase.storage
            .from('events')
            .getPublicUrl(filePath);

          // DB에 저장
          const { error: dbError } = await supabase
            .from('event_photos')
            .insert([{
              event_id: currentEventId,
              image_url: urlData.publicUrl,
              caption: caption || null
            }]);

          if (dbError) throw dbError;

          alert('사진이 업로드되었습니다!');

          // 모달 닫기 및 폼 초기화
          bootstrap.Modal.getInstance(document.getElementById('uploadPhotoModal')).hide();
          document.getElementById('uploadPhotoForm').reset();
          document.getElementById('photoPreview').style.display = 'none';

          // 사진 새로고침
          loadEventPhotos(currentEventId);
        } catch (error) {
          console.error('업로드 오류:', error);
          alert('업로드에 실패했습니다: ' + error.message);
        }
      }

      // 유틸리티
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // 미리보기
      document.getElementById('photoFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            alert('이미지 크기는 5MB 이하여야 합니다.');
            this.value = '';
            return;
          }
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('photoPreviewImg').src = e.target.result;
            document.getElementById('photoPreview').style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      // 페이지 로드
      document.addEventListener('DOMContentLoaded', loadEventDetail);
    </script>

  </body>

</html>
