<!DOCTYPE html>
<html class="has-sidemenu" lang="ko-KR" dir="ltr">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="민족통일청년회 영동군 지부 회원 게시판">

    <title>회원 게시판 | 민족통일청년회 영동군</title>

    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicons/favicon-16x16.png">
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicons/favicon.ico">
    <link rel="manifest" href="assets/img/favicons/manifest.json">
    <meta name="msapplication-TileImage" content="assets/img/favicons/mstile-150x150.png">
    <meta name="theme-color" content="#ffffff">

    <link href="vendors/loaders.css/loaders.min.css" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=PT+Mono%7cPT+Serif:400,400i%7cLato:100,300,400,700,800,900" rel="stylesheet">
    <link href="assets/css/theme.css" rel="stylesheet" />
    <link href="assets/css/user.css" rel="stylesheet" />
    <link href="assets/css/floating-board.css" rel="stylesheet" />

    <style>
      .fancynavbar-togglerbar {
        background-color: #000 !important;
      }

      .board-item {
        background: #fff;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.2s ease;
      }

      .board-item:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      }

      .board-item-header {
        cursor: pointer;
      }

      .board-item-top {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
      }

      .board-item-title {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .board-item-category {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        flex-shrink: 0;
        white-space: nowrap;
      }

      .category-info { background: #e3f2fd; color: #1565c0; }
      .category-request { background: #fff3e0; color: #e65100; }
      .category-share { background: #e8f5e9; color: #2e7d32; }
      .category-etc { background: #f3e5f5; color: #7b1fa2; }

      .board-item-content {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.75rem;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .board-item-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: #999;
      }

      .board-item-author {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .board-item-author img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
      }

      .board-item-stats {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .board-item-stats span {
        white-space: nowrap;
      }

      .board-item-actions {
        display: flex;
        gap: 0.25rem;
      }

      .board-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .filter-btn {
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        border: 1px solid #ddd;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s;
      }

      .filter-btn:hover {
        border-color: #000;
      }

      .filter-btn.active {
        background: #000;
        color: #fff;
        border-color: #000;
      }

      .board-search {
        position: relative;
        margin-bottom: 1rem;
      }

      .board-search input {
        width: 100%;
        padding: 0.6rem 2.5rem 0.6rem 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.2s;
      }

      .board-search input:focus {
        outline: none;
        border-color: #000;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
      }

      .board-search-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        pointer-events: none;
      }

      .board-search input::placeholder {
        color: #aaa;
      }

      .post-images {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 0.5rem;
        margin-top: 0.75rem;
      }

      .post-image {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        aspect-ratio: 1;
        cursor: pointer;
        border: 1px solid #e0e0e0;
        transition: all 0.2s;
      }

      .post-image:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      .post-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .post-images.single-image {
        grid-template-columns: 1fr;
        max-width: 500px;
      }

      .post-images.single-image .post-image {
        aspect-ratio: 16 / 9;
      }

      @media (max-width: 768px) {
        .board-item { padding: 1rem; }
        .board-item-title { font-size: 0.9rem; }
        .board-item-stats { gap: 0.5rem; font-size: 0.7rem; }
        .board-item-content { font-size: 0.8rem; }
        .board-item-meta { flex-wrap: wrap; gap: 0.5rem; }
      }
    </style>
  </head>

  <body class="overflow-hidden-x">

    <nav class="fancynavbar fancynavbar-expand-lg">
      <div class="fancynavbar-togglerbar"><a class="fancynavbar-brand" href="index.html"><img class="fancynavbar-brand-img" src="assets/img/logo-sparrow-invert.svg" alt="" width="30" height="30" /></a>
        <div class="fancynavbar-toggler">
          <svg class="fancynavbar-toggler-icon" viewBox="0 0 70 70" xmlns="http://www.w3.org/2000/svg">
            <path id="path-top" d="M20,25c0,0,22,0,30,0c16,0,18.89,40.71-.15,21.75C38.7,35.65,19.9,16.8,19.9,16.8"></path>
            <path id="path-middle" d="M20,32h30"></path>
            <path id="path-bottom" d="M19.9,46.98c0,0,18.8-18.85,29.95-29.95C68.89-1.92,66,38.78,50,38.78c-8,0-30,0-30,0"></path>
          </svg>
        </div>
        <div class="fancynavbar-addon fancynavbar-addon-height"><a class="fancynavbar-addon-item" href="https://twitter.com" target="_blank" rel="noopener"><span class="fab fa-twitter"></span></a><a class="fancynavbar-addon-item" href="https://facebook.com" target="_blank" rel="noopener"><span class="fab fa-facebook"></span></a>
        </div>
      </div>
      <div class="fancynavbar-collapse">
        <ul class="fancynavbar-nav">
          <li class="fancynav-item"><a class="fancynav-link" href="index.html"><span class="fancynav-link-content">홈</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="about.html"><span class="fancynav-link-content">협의회 소개</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="services.html"><span class="fancynav-link-content">회계</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="members.html"><span class="fancynav-link-content">회원소개</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link active" href="board.html"><span class="fancynav-link-content">회원게시판</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="news.html"><span class="fancynav-link-content">활동 소식</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="events.html"><span class="fancynav-link-content">행사&사진</span></a></li>
          <li class="fancynav-item"><a class="fancynav-link" href="contact.html"><span class="fancynav-link-content">연락처</span></a></li>
        </ul>
      </div>
    </nav>

    <main class="main min-vh-100" id="top">

      <div class="preloader" id="preloader">
        <div class="loader">
          <div class="line-scale-pulse-out-rapid">
            <div> </div>
            <div></div>
            <div></div>
            <div></div>
            <div> </div>
          </div>
        </div>
      </div>

      <section class="py-7 py-md-9">
        <div class="container">
          <div class="row flex-center">
            <div class="col-12 text-center mb-4">
              <h1 class="fs-5 fs-md-4 text-decoration-underline d-inline-block mb-3">회원 게시판</h1>
              <p class="text-body-tertiary">회원간 정보 공유 및 소통 공간</p>
            </div>
          </div>

          <div class="row justify-content-center">
            <div class="col-lg-10">

              <!-- 검색창 -->
              <div class="board-search">
                <input type="text" id="searchInput" placeholder="제목, 내용, 작성자로 검색하세요..." />
                <span class="board-search-icon">
                  <i class="fas fa-search"></i>
                </span>
              </div>

              <!-- 필터 및 글쓰기 버튼 -->
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="board-filters" id="boardFilters">
                  <button type="button" class="filter-btn active" data-category="">전체</button>
                  <button type="button" class="filter-btn" data-category="info">정보공유</button>
                  <button type="button" class="filter-btn" data-category="request">업무요청</button>
                  <button type="button" class="filter-btn" data-category="share">나눔</button>
                  <button type="button" class="filter-btn" data-category="etc">기타</button>
                </div>
                <a href="board-write.html" class="btn btn-primary btn-sm" id="writeBtn">
                  <span class="fas fa-pen me-1"></span>글쓰기
                </a>
              </div>

              <!-- 게시판 목록 -->
              <div id="boardList">
                <!-- 게시글이 여기에 로드됨 -->
              </div>

              <!-- 빈 상태 -->
              <div id="emptyState" class="text-center py-5" style="display: none;">
                <span class="fas fa-clipboard-list fa-3x text-body-tertiary mb-3"></span>
                <p class="text-body-secondary">등록된 게시글이 없습니다.</p>
                <a href="board-write.html" class="btn btn-outline-primary btn-sm">첫 글 작성하기</a>
              </div>

    <!-- 수정 모달 -->
    <div class="modal fade" id="editPostModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><span class="fas fa-edit me-2"></span>게시글 수정</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editPostForm">
              <input type="hidden" id="edit_post_id">
              <div class="mb-3">
                <label class="form-label fw-bold">비밀번호 <span class="text-danger">*</span></label>
                <input type="password" class="form-control" id="edit_password" required placeholder="글 작성 시 설정한 비밀번호">
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">카테고리</label>
                <select class="form-select" id="edit_category">
                  <option value="info">정보공유</option>
                  <option value="request">업무요청</option>
                  <option value="share">나눔</option>
                  <option value="etc">기타</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">제목</label>
                <input type="text" class="form-control" id="edit_title" required>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">내용</label>
                <textarea class="form-control" id="edit_content" rows="6" required></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-primary" onclick="submitEditPost()">수정 완료</button>
          </div>
        </div>
      </div>
    </div>

            </div>
          </div>
        </div>
      </section>

    </main>

    <footer class="footer bg-black text-body-secondary py-4 font-secondary text-center overflow-hidden">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-4 order-lg-2 position-relative"><a class="indicator indicator-up" href="#top"><span class="indicator-arrow indicator-arrow-one"></span><span class="indicator-arrow indicator-arrow-two"></span></a></div>
          <div class="col-lg-4 text-lg-start mt-4 mt-lg-0">
            <p class="fs-10 ls fw-bold mb-0">Copyright &copy; 2025 민족통일청년회 영동군</p>
            <p class="fs-10 mb-0 mt-2"><a href="http://www.mintong.or.kr/mt/main" target="_blank" class="text-body-secondary">민족통일협의회</a></p>
          </div>
          <div class="col-lg-4 text-lg-end order-lg-2 mt-2 mt-lg-0">
            <p class="fs-10 mb-0">충청북도 영동군 | 문의: conexus25@conexus.co.kr</p>
          </div>
        </div>
      </div>
    </footer>

    <script src="vendors/popper/popper.min.js"></script>
    <script src="vendors/bootstrap/bootstrap.min.js"></script>
    <script src="vendors/anchorjs/anchor.min.js"></script>
    <script src="vendors/is/is.min.js"></script>
    <script src="vendors/fontawesome/all.min.js"></script>
    <script src="vendors/lodash/lodash.min.js"></script>
    <script src="vendors/imagesloaded/imagesloaded.pkgd.js"></script>
    <script src="vendors/gsap/gsap.js"></script>
    <script src="vendors/gsap/customEase.js"></script>
    <script src="vendors/gsap/drawSVGPlugin.js"></script>
    <script src="assets/js/theme.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-config.js"></script>

    <!-- Floating Board -->
    <script src="assets/js/floating-board.js"></script>

    <script>
      const boardList = document.getElementById('boardList');
      const emptyState = document.getElementById('emptyState');
      const filterBtns = document.querySelectorAll('.filter-btn');
      const searchInput = document.getElementById('searchInput');

      let currentCategory = '';
      let currentSearchKeyword = '';
      let allPosts = [];

      // 카테고리 클래스 매핑
      const categoryClass = {
        'info': 'category-info',
        'request': 'category-request',
        'share': 'category-share',
        'etc': 'category-etc'
      };

      const categoryLabel = {
        'info': '정보공유',
        'request': '업무요청',
        'share': '나눔',
        'etc': '기타'
      };

      // 작성자별 이미지
      const authorImages = {
        '김종원': 'assets/img/team/0.jpg',
        '임진석': 'assets/img/team/1.jpg',
        '박수용': 'assets/img/team/8.jpg',
        '연규영': 'assets/img/team/2.jpg',
        '최원호': 'assets/img/team/3.jpg',
        '채흥열': 'assets/img/team/1.jpg',
        '조훈희': 'assets/img/team/0.jpg',
        '김영균': 'assets/img/team/4.jpg',
        '이경환': 'assets/img/team/4.jpg',
        '김용국': 'assets/img/team/2.jpg',
        '윤용수': 'assets/img/team/5.jpg',
        '정성용': 'assets/img/team/9.jpg',
        '한성욱': 'assets/img/team/6.jpg',
        '박성현': 'assets/img/team/7.jpg'
      };

      // 게시글 로드
      async function loadPosts() {
        try {
          // 각 게시글의 댓글 개수도 함께 가져오기
          const { data, error } = await supabase
            .from('board_posts')
            .select('*')
            .order('created_at', { ascending: false });

          if (error) throw error;

          // 댓글 개수 가져오기
          const postsWithComments = await Promise.all(
            (data || []).map(async (post) => {
              const { count } = await supabase
                .from('board_comments')
                .select('*', { count: 'exact', head: true })
                .eq('post_id', post.id);
              return { ...post, comments: count || 0 };
            })
          );

          allPosts = postsWithComments;
          renderPosts();
        } catch (error) {
          console.error('게시글 로드 오류:', error);
          allPosts = [];
          renderPosts();
        }
      }

      // 게시글 렌더링
      function renderPosts() {
        let posts = allPosts;

        // 카테고리 필터링
        if (currentCategory) {
          posts = posts.filter(p => p.category === currentCategory);
        }

        // 검색 키워드 필터링
        if (currentSearchKeyword) {
          const keyword = currentSearchKeyword.toLowerCase();
          posts = posts.filter(p => {
            return p.title.toLowerCase().includes(keyword) ||
                   p.content.toLowerCase().includes(keyword) ||
                   p.author_name.toLowerCase().includes(keyword);
          });
        }

        if (posts.length === 0) {
          boardList.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }

        emptyState.style.display = 'none';

        boardList.innerHTML = posts.map(post => {
          const date = new Date(post.created_at);
          const dateStr = date.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }).replace('.', '월 ').replace('.', '일');
          const authorImg = post.author_img || authorImages[post.author_name] || 'assets/img/team/0.jpg';

          return `
            <div class="board-item" id="post-${post.id}">
              <div class="board-item-header" onclick="togglePostComments('${post.id}')">
                <div class="board-item-top">
                  <h3 class="board-item-title">${escapeHtml(post.title)}</h3>
                  <span class="board-item-category ${categoryClass[post.category] || 'category-etc'}">
                    ${categoryLabel[post.category] || '기타'}
                  </span>
                  <span class="toggle-icon" id="toggle-${post.id}">
                    <i class="fas fa-chevron-down"></i>
                  </span>
                </div>
                <p class="board-item-content">${escapeHtml(post.content)}</p>
                ${renderPostImages(post.images, true)}
                <div class="board-item-meta">
                  <div class="board-item-author">
                    <img src="${authorImg}" alt="${post.author_name}">
                    <span>${post.author_name}</span>
                  </div>
                  <div class="board-item-stats">
                    <span><i class="far fa-eye"></i> ${post.views || 0}</span>
                    <span><i class="far fa-comment"></i> ${post.comments || 0}</span>
                    <span>${dateStr}</span>
                    <div class="board-item-actions">
                      <button class="btn btn-sm btn-link text-secondary p-0" onclick="event.stopPropagation(); openEditModal('${post.id}')" title="수정">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-link text-danger p-0" onclick="event.stopPropagation(); deletePost('${post.id}')" title="삭제">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 댓글 섹션 (초기에는 숨김) -->
              <div class="comments-section mt-3 pt-3 border-top" id="comments-section-${post.id}" style="display:none;">
                <!-- 전체 내용 표시 -->
                <div class="mb-3 p-3 bg-light rounded">
                  <p class="mb-0" style="white-space: pre-wrap;">${escapeHtml(post.content)}</p>
                  ${renderPostImages(post.images, false)}
                </div>

                <div class="mb-3">
                  <strong class="text-primary"><i class="fas fa-comments me-2"></i>댓글 ${post.comments || 0}개</strong>
                </div>

                <!-- 댓글 작성 폼 -->
                <div class="card p-3 mb-3 bg-light">
                  <form onsubmit="submitComment(event, '${post.id}')">
                    <div class="row g-2">
                      <div class="col-md-3">
                        <select class="form-select form-select-sm" name="author_name" required>
                          <option value="">작성자</option>
                          <option value="김종원">김종원</option>
                          <option value="임진석">임진석</option>
                          <option value="박수용">박수용</option>
                          <option value="연규영">연규영</option>
                          <option value="최원호">최원호</option>
                          <option value="채흥열">채흥열</option>
                          <option value="조훈희">조훈희</option>
                          <option value="김영균">김영균</option>
                          <option value="이경환">이경환</option>
                          <option value="김용국">김용국</option>
                          <option value="윤용수">윤용수</option>
                          <option value="정성용">정성용</option>
                          <option value="한성욱">한성욱</option>
                          <option value="박성현">박성현</option>
                        </select>
                      </div>
                      <div class="col-md-7">
                        <input type="text" class="form-control form-control-sm" name="content" placeholder="댓글을 입력하세요" required>
                      </div>
                      <div class="col-md-2">
                        <button type="submit" class="btn btn-sm btn-primary w-100">
                          <i class="fas fa-paper-plane"></i>
                        </button>
                      </div>
                    </div>
                  </form>
                </div>

                <!-- 댓글 목록 -->
                <div id="comments-list-${post.id}">
                  <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      // 댓글 토글
      async function togglePostComments(postId) {
        const section = document.getElementById(`comments-section-${postId}`);
        const icon = document.getElementById(`toggle-${postId}`);

        if (section.style.display === 'none') {
          section.style.display = 'block';
          icon.innerHTML = '<i class="fas fa-chevron-up"></i>';
          await loadComments(postId);
        } else {
          section.style.display = 'none';
          icon.innerHTML = '<i class="fas fa-chevron-down"></i>';
        }
      }

      // 댓글 로드
      async function loadComments(postId) {
        try {
          const { data: comments, error } = await supabase
            .from('board_comments')
            .select('*')
            .eq('post_id', postId)
            .order('created_at', { ascending: true });

          if (error) throw error;

          displayComments(postId, comments || []);
        } catch (error) {
          console.error('댓글 로드 오류:', error);
          displayComments(postId, []);
        }
      }

      // 댓글 표시
      function displayComments(postId, comments) {
        const container = document.getElementById(`comments-list-${postId}`);

        if (comments.length === 0) {
          container.innerHTML = '<p class="text-body-secondary text-center py-3">첫 댓글을 작성해보세요!</p>';
          return;
        }

        container.innerHTML = comments.map(comment => {
          const date = new Date(comment.created_at);
          const dateStr = date.toLocaleDateString('ko-KR', {
            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
          });
          const img = authorImages[comment.author_name] || 'assets/img/team/0.jpg';

          return `
            <div class="comment-item mb-2 pb-2 border-bottom">
              <div class="d-flex align-items-center gap-2 mb-1">
                <img src="${img}" alt="${comment.author_name}" width="24" height="24" class="rounded-circle">
                <strong>${escapeHtml(comment.author_name)}</strong>
                <small class="text-body-secondary ms-auto">${dateStr}</small>
              </div>
              <p class="mb-0 text-body-secondary ps-4">${escapeHtml(comment.content)}</p>
            </div>
          `;
        }).join('');
      }

      // 댓글 작성
      async function submitComment(event, postId) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        try {
          const { error } = await supabase
            .from('board_comments')
            .insert([{
              post_id: parseInt(postId),
              author_name: formData.get('author_name'),
              content: formData.get('content')
            }]);

          if (error) throw error;

          form.reset();
          await loadComments(postId);
          await loadPosts(); // 댓글 개수 업데이트
        } catch (error) {
          console.error('댓글 작성 오류:', error);
          alert('댓글 작성에 실패했습니다.');
        }
      }

      // 수정 모달 열기
      async function openEditModal(postId) {
        try {
          const { data: post, error } = await supabase
            .from('board_posts')
            .select('*')
            .eq('id', postId)
            .single();

          if (error) throw error;

          document.getElementById('edit_post_id').value = post.id;
          document.getElementById('edit_category').value = post.category;
          document.getElementById('edit_title').value = post.title;
          document.getElementById('edit_content').value = post.content;
          document.getElementById('edit_password').value = '';

          const modal = new bootstrap.Modal(document.getElementById('editPostModal'));
          modal.show();
        } catch (error) {
          console.error('게시글 로드 오류:', error);
          alert('게시글을 불러오는데 실패했습니다.');
        }
      }

      // 수정 제출
      async function submitEditPost() {
        const postId = document.getElementById('edit_post_id').value;
        const password = document.getElementById('edit_password').value;

        try {
          // 비밀번호 확인
          const { data: post, error: fetchError } = await supabase
            .from('board_posts')
            .select('password')
            .eq('id', postId)
            .single();

          if (fetchError) throw fetchError;

          if (post.password !== password) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
          }

          // 수정
          const { error } = await supabase
            .from('board_posts')
            .update({
              category: document.getElementById('edit_category').value,
              title: document.getElementById('edit_title').value,
              content: document.getElementById('edit_content').value,
              updated_at: new Date().toISOString()
            })
            .eq('id', postId);

          if (error) throw error;

          alert('수정되었습니다.');
          bootstrap.Modal.getInstance(document.getElementById('editPostModal')).hide();
          await loadPosts();
        } catch (error) {
          console.error('수정 오류:', error);
          alert('수정에 실패했습니다.');
        }
      }

      // 삭제
      async function deletePost(postId) {
        const password = prompt('비밀번호를 입력하세요:');
        if (!password) return;

        try {
          const { data: post, error: fetchError } = await supabase
            .from('board_posts')
            .select('password, title')
            .eq('id', postId)
            .single();

          if (fetchError) throw fetchError;

          if (post.password !== password) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
          }

          if (!confirm(`"${post.title}" 글을 삭제하시겠습니까?`)) return;

          const { error } = await supabase
            .from('board_posts')
            .delete()
            .eq('id', postId);

          if (error) throw error;

          alert('삭제되었습니다.');
          await loadPosts();
        } catch (error) {
          console.error('삭제 오류:', error);
          alert('삭제에 실패했습니다.');
        }
      }

      // HTML 이스케이프
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // 게시글 이미지 렌더링
      function renderPostImages(images, isPreview = false) {
        if (!images || !Array.isArray(images) || images.length === 0) {
          return '';
        }

        // 미리보기일 때는 첫 번째 이미지만 표시
        const displayImages = isPreview ? images.slice(0, 1) : images;
        const singleClass = displayImages.length === 1 ? 'single-image' : '';
        const moreText = isPreview && images.length > 1 ? `<span class="text-body-secondary small ms-2">+${images.length - 1}장 더보기</span>` : '';

        return `
          <div class="post-images ${singleClass}">
            ${displayImages.map((imgUrl, index) => `
              <div class="post-image" onclick="event.stopPropagation(); window.open('${imgUrl}', '_blank')">
                <img src="${imgUrl}" alt="첨부 이미지 ${index + 1}" loading="lazy">
              </div>
            `).join('')}
          </div>
          ${moreText}
        `;
      }

      // 필터 버튼 클릭
      filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          filterBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentCategory = this.getAttribute('data-category');
          renderPosts();
        });
      });

      // 검색 입력 이벤트
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentSearchKeyword = this.value.trim();
          renderPosts();
        }, 300); // 300ms 디바운스
      });

      // 초기 로드
      document.addEventListener('DOMContentLoaded', async () => {
        // Supabase 준비 대기
        try {
          if (typeof waitForSupabase === 'function') {
            await waitForSupabase(5000);
          }
        } catch (error) {
          console.warn('Supabase 로딩 실패:', error.message);
        }

        if (supabase) {
          loadPosts();
        } else {
          const loadingEl = document.getElementById('postsLoading');
          const postsContainer = document.getElementById('postsContainer');
          if (loadingEl) loadingEl.style.display = 'none';
          if (postsContainer) {
            postsContainer.innerHTML = `
              <div class="text-center py-5 text-body-secondary">
                <p><span class="fas fa-exclamation-triangle me-2"></span>데이터를 불러올 수 없습니다.</p>
                <button class="btn btn-primary mt-3" onclick="location.reload()">새로고침</button>
              </div>
            `;
          }
        }
      });
    </script>

  </body>

</html>
